services:
  traefik:
    image: traefik:v2.10
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.file.directory=/etc/traefik/dynamic"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.myresolver.acme.httpchallenge=true"
      - "--certificatesResolvers.myresolver.acme.httpchallenge.entrypoint=web"
      - "--certificatesResolvers.myresolver.acme.email=admin@apartament340.pl"
      - "--certificatesResolvers.myresolver.acme.storage=/letsencrypt/acme.json"
      # Global HTTP to HTTPS redirect
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--entrypoints.web.http.redirections.entrypoint.permanent=true"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "./traefik/acme.json:/letsencrypt/acme.json"
      - "./traefik/dynamic:/etc/traefik/dynamic"
    restart: always

  backend:
    build: ./backend
    command: gunicorn booking_project.wsgi:application --bind 0.0.0.0:8000
    volumes:
      - ./backend:/app
      - ./traefik/dynamic:/etc/traefik/dynamic
    env_file:
      - .env
    environment:
      - DJANGO_SETTINGS_MODULE=booking_project.settings
      - DJANGO_DEBUG=False
      - SENDGRID_API_KEY=${SENDGRID_API_KEY}
      - DEFAULT_FROM_EMAIL=${DEFAULT_FROM_EMAIL:-noreply@dotfusion.eu}
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_HOST=db
      - POSTGRES_PORT=5432
      - EMAIL_HOST=${EMAIL_HOST:-postfix}
      - EMAIL_PORT=${EMAIL_PORT:-25}
      - EMAIL_HOST_USER=${EMAIL_HOST_USER:-}
      - EMAIL_HOST_PASSWORD=${EMAIL_HOST_PASSWORD:-}
      - EMAIL_USE_TLS=${EMAIL_USE_TLS:-False}
      - EMAIL_USE_SSL=${EMAIL_USE_SSL:-False}
      - SECRET_KEY=${SECRET_KEY}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS}
      - TWILIO_ACCOUNT_SID=${TWILIO_ACCOUNT_SID}
      - TWILIO_AUTH_TOKEN=${TWILIO_AUTH_TOKEN}
      - TWILIO_FROM_NUMBER=${TWILIO_FROM_NUMBER}
      - HOST_EMAIL=${HOST_EMAIL}
      - HOST_PHONE=${HOST_PHONE}
    depends_on:
      - db
      - postfix
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.backend.rule=Host(`api.apartament340.pl`)"
      - "traefik.http.routers.backend.entrypoints=websecure"
      - "traefik.http.routers.backend.tls.certresolver=myresolver"
      - "traefik.http.routers.backend.priority=10"
      - "traefik.http.services.backend.loadbalancer.server.port=8000"
    restart: always

  website:
    build: ./web
    labels:
      - "traefik.enable=true"
      
      # WWW redirect router (HTTPS) - redirects www.apartament340.pl to apartament340.pl
      - "traefik.http.routers.website-www-redirect.rule=Host(`www.apartament340.pl`)"
      - "traefik.http.routers.website-www-redirect.entrypoints=websecure"
      - "traefik.http.routers.website-www-redirect.tls.certresolver=myresolver"
      - "traefik.http.routers.website-www-redirect.priority=200"
      - "traefik.http.middlewares.www-redirect.redirectregex.regex=^https://www\\.(.+)"
      - "traefik.http.middlewares.www-redirect.redirectregex.replacement=https://$${1}"
      - "traefik.http.middlewares.www-redirect.redirectregex.permanent=true"
      - "traefik.http.routers.website-www-redirect.middlewares=www-redirect"
      
      # Catch-all for unregistered domains (fallback certificate)
      - "traefik.http.routers.website-catchall.rule=!Host(`admin.apartament340.pl`) && !Host(`api.apartament340.pl`) && !Host(`mail.apartament340.pl`)"
      - "traefik.http.routers.website-catchall.entrypoints=websecure"
      - "traefik.http.routers.website-catchall.tls=true"
      - "traefik.http.routers.website-catchall.priority=1"
      - "traefik.http.services.website.loadbalancer.server.port=5173"
      
      # HTTP routers (will be redirected to HTTPS by global redirect)
      - "traefik.http.routers.website-http.rule=!Host(`admin.apartament340.pl`) && !Host(`api.apartament340.pl`) && !Host(`mail.apartament340.pl`)"
      - "traefik.http.routers.website-http.entrypoints=web"
      - "traefik.http.routers.website-http.priority=1"
    restart: always

  admin:
    build:
      context: ./ui
      args:
        REACT_APP_API_URL: https://api.apartament340.pl/api
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.admin.rule=Host(`admin.apartament340.pl`)"
      - "traefik.http.routers.admin.entrypoints=websecure"
      - "traefik.http.routers.admin.tls.certresolver=myresolver"
      - "traefik.http.routers.admin.priority=10"
      - "traefik.http.services.admin.loadbalancer.server.port=3000"
    restart: always
    environment:
      - REACT_APP_API_URL=https://api.apartament340.pl/api

  # Production SMTP server
  postfix:
    image: boky/postfix:latest
    environment:
      - ALLOWED_SENDER_DOMAINS=${MAIL_DOMAIN:-dotfusion.eu}
      - HOSTNAME=${MAIL_DOMAIN:-dotfusion.eu}
    # No external ports - only internal communication
    restart: always


  db:
    image: postgres:15
    env_file:
      - .env
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    ports:
      - "127.0.0.1:5432:5432"
    volumes:
      - booking_data:/var/lib/postgresql/data
    restart: always

volumes:
  booking_data: 